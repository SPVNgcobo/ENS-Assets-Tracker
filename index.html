<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ENSAT | Enterprise Asset Tracker</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* ---------- THEME & TOKENS ---------- */
    :root{
      --primary-yellow:#FFD200;
      --primary-black:#111;
      --text-dark:#1a1a1a;
      --text-light:#7f8c8d;
      --bg-app:#f4f6f8;
      --surface:#fff;
      --border:#e1e4e8;
      --success:#27ae60;
      --danger:#e74c3c;
      --sidebar-w:260px;
      --trans:0.3s cubic-bezier(.4,0,.2,1);
    }
    body.dark-mode{
      --bg-app:#0a0a0a;
      --surface:#141414;
      --text-dark:#f0f0f0;
      --text-light:#a0a0a0;
      --border:#333;
    }

    *{box-sizing:border-box;margin:0;padding:0;font-family:Segoe UI, Roboto, Helvetica, Arial, sans-serif}
    body{background:var(--bg-app);color:var(--text-dark);height:100vh;display:flex;overflow:hidden;transition:background var(--trans)}
    .card{background:var(--surface);border-radius:8px;padding:20px;border:1px solid var(--border);}

    /* --- layout --- */
    body.login-mode{background:var(--primary-black);align-items:center;justify-content:center}
    .auth-container{background:var(--surface);width:100%;max-width:420px;padding:36px;border-radius:8px;border-top:4px solid var(--primary-yellow);box-shadow:0 20px 40px rgba(0,0,0,.45)}
    .login-logo-img{display:block;margin:0 auto 10px;max-width:200px}

    /* SIDEBAR (Updated to be hidden by default) */
    .sidebar {
      width: var(--sidebar-w);
      background: var(--primary-black);
      color: #fff;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #222;
      z-index: 1000; /* High z-index to float over everything */
      transition: var(--trans);
      height: 100vh;
      position: fixed; /* Fixed position */
      left: -260px; /* Hidden by default */
      top: 0;
    }
    
    /* Active state for sidebar (slide in) */
    .sidebar.active {
      left: 0;
      box-shadow: 10px 0 50px rgba(0,0,0,0.45);
    }

    .logo-area{height:70px;display:flex;align-items:center;padding:0 20px;border-bottom:1px solid #222;background:#000}
    .sidebar .scroll-nav{flex:1;overflow:auto;padding:18px 0}
    .sidebar .scroll-nav::-webkit-scrollbar{width:8px}
    .sidebar .scroll-nav::-webkit-scrollbar-thumb{background:#222;border-radius:8px}
    .nav-label{font-size:11px;text-transform:uppercase;color:#666;padding:0 20px;margin:15px 0 6px;font-weight:700}
    .nav-item{padding:12px 20px;cursor:pointer;display:flex;align-items:center;gap:12px;color:#bbb;font-size:14px;transition:0.15s;border-left:3px solid transparent}
    .nav-item.active{background:rgba(255,210,0,0.08);color:var(--primary-yellow);border-left-color:var(--primary-yellow)}
    .sidebar-footer{padding:16px;border-top:1px solid #222;background:#050505}

    /* MAIN CONTENT (Updated to be full width) */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
      background: var(--bg-app);
      height: 100vh;
      overflow: hidden;
      width: 100%; /* Full width */
      margin-left: 0; /* No margin */
    }

    .header{height:70px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;padding:0 24px;z-index:50}
    .content-area{padding:24px;overflow:auto;height:calc(100vh - 70px)}
    .view-section{display:none;animation:fadeIn .3s ease}
    .view-section.active-view{display:block}

    /* Mobile Toggle is always visible now */
    .mobile-toggle {
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border-radius: 4px;
    }
    .mobile-toggle:hover { background: rgba(0,0,0,0.05); }

    /* small helpers */
    .stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;margin-bottom:20px}
    .stat-card{padding:18px;border-left:4px solid transparent;box-shadow:0 2px 5px rgba(0,0,0,0.04)}
    .stat-card .value{font-size:22px;font-weight:800}
    .stat-card.yellow{border-color:var(--primary-yellow)}
    .stat-card.red{border-color:var(--danger)}
    .stat-card.green{border-color:var(--success)}

    .tbl-header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;border-radius:8px 8px 0 0}
    table{width:100%;border-collapse:collapse}
    th, td{padding:12px 16px;border-bottom:1px solid var(--border);font-size:13px;}
    th{color:var(--text-light);font-size:12px;text-align:left;cursor:pointer;}
    th:hover{background:rgba(0,0,0,0.02)}
    .btn{padding:8px 14px;border-radius:6px;border:none;cursor:pointer;font-weight:700}
    .btn-primary{background:var(--primary-yellow);color:#000}
    .btn-secondary{background:var(--surface);border:1px solid var(--border)}
    .btn-ghost{background:transparent;color:var(--text-light)}

    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.55);z-index:999;display:none;align-items:center;justify-content:center;backdrop-filter:blur(2px)}
    .modal{width:100%;max-width:520px;background:var(--surface);border-radius:8px;padding:20px;border:1px solid var(--border);transform:scale(.96);transition:transform .25s}
    .modal.open{transform:scale(1)}
    
    .signature-wrapper{background:#fff;border:2px dashed var(--border);border-radius:6px;position:relative;overflow:hidden}

    /* Workflow Steps */
    .step{width:32px;height:32px;border-radius:50%;background:#ddd;display:flex;align-items:center;justify-content:center;font-weight:700;color:#666}
    .step.active{background:var(--primary-yellow);color:#000}
    
    .asset-details-box {
        background: var(--bg-app);
        padding: 15px;
        border-radius: 6px;
        margin-top: 15px;
        border: 1px solid var(--border);
        font-size: 13px;
    }
    .asset-row { display: flex; justify-content: space-between; margin-bottom: 6px; border-bottom: 1px dashed #ddd; padding-bottom: 4px; }
    .asset-row:last-child { border-bottom: none; margin-bottom: 0; }
    .asset-label { color: var(--text-light); font-weight: 600; }
    .asset-val { font-weight: 700; }
    
    .form-group { margin-bottom: 15px; }
    .form-label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 13px; }
    .form-control { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 4px; background: var(--surface); color: var(--text-dark); }

    /* responsive */
    @media(max-width:768px){
      .stats-row{grid-template-columns:repeat(2,1fr)}
      .content-area{padding:16px}
    }
    
    /* PRINT STYLES */
    @media print {
        .sidebar, .header, .btn, .modal-overlay, #toastContainer, .nav-item, .mobile-toggle { display: none !important; }
        .main, .content-area { margin: 0 !important; padding: 0 !important; height: auto !important; overflow: visible !important; }
        .card { border: none !important; box-shadow: none !important; }
        body { background: #fff; height: auto; }
    }

    /* status badges */
    .status-badge{padding:6px 8px;border-radius:6px;font-weight:700;font-size:12px;color:#fff;display:inline-block}
    .st-good{background:var(--success)}
    .st-assigned{background:#333}
    .st-damaged{background:var(--danger)}
    .st-maint{background:#f39c12}
    .live-badge{background:#e74c3c;color:#fff;padding:4px 8px;border-radius:6px;font-size:11px;font-weight:800}

    /* Toast */
    .toast{background:#333;color:#fff;padding:12px 24px;border-radius:4px;margin-top:10px;box-shadow:0 5px 15px rgba(0,0,0,0.2);animation:fadeIn 0.3s forwards}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
  </style>
</head>
<body class="login-mode">

  <div id="view-login">
    <div class="auth-container card">
      <img id="login-logo" class="login-logo-img" src="https://dummyimage.com/240x80/000000/FFD200.png&text=ENSafrica" alt="ENS">
      <div class="auth-subtitle" id="auth-subtitle" style="text-align:center;color:var(--text-light);margin-bottom:24px">Enterprise Asset Management</div>

      <div id="login-error" style="display:none;background:#fee;color:var(--danger);padding:10px;border-radius:4px;margin-bottom:15px;font-size:13px;font-weight:700;text-align:center"></div>

      <form onsubmit="App.handleAuth(event)">
        <div class="form-group signup-field" style="display:none">
          <label class="form-label">Full Name</label>
          <input id="signup-name" class="form-control" placeholder="e.g. John Doe">
        </div>
        <div class="form-group signup-field" style="display:none">
          <label class="form-label">Role</label>
          <select id="signup-role" class="form-control">
            <option>IT Asset Mgr</option><option>Controller</option><option>Auditor</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Email / Username</label>
          <div style="position:relative">
            <i class="fas fa-user" style="position:absolute;left:10px;top:12px;color:#999"></i>
            <input id="login-email" class="form-control" style="padding-left:36px" placeholder="admin" value="admin">
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Password</label>
          <div style="position:relative">
            <i class="fas fa-lock" style="position:absolute;left:10px;top:12px;color:#999"></i>
            <input id="login-password" type="password" class="form-control" style="padding-left:36px" value="password">
          </div>
        </div>

        <button id="btn-login" class="btn btn-primary" style="width:100%;padding:12px"><span id="auth-btn-label">Sign In</span> <i class="fas fa-arrow-right" style="margin-left:8px"></i></button>
      </form>

      <div style="margin-top:16px;text-align:center;font-size:13px">
        <span id="auth-switch-text">Don't have an account?</span>
        <a id="auth-switch-link" style="margin-left:6px;cursor:pointer;color:var(--primary-yellow);font-weight:bold" onclick="App.toggleAuthMode()">Sign Up</a>
      </div>
    </div>
  </div>

  <div id="view-app" style="display:none;flex:1">
    <div class="sidebar" id="sidebar">
      <div class="logo-area"><span style="color:var(--primary-yellow);font-weight:800;font-size:20px">ENS</span></div>
      <div class="scroll-nav">
        <div class="nav-label">Overview</div>
        <div class="nav-item active" onclick="UI.switchView('dashboard', this)"><i class="fas fa-chart-pie"></i> Dashboard</div>
        <div class="nav-item" onclick="UI.switchView('inventory', this)"><i class="fas fa-boxes"></i> Inventory DB</div>
        <div class="nav-item" onclick="UI.switchView('history', this)"><i class="fas fa-history"></i> Audit Log</div>

        <div style="height:20px"></div>
        <div class="nav-label">Workflows</div>
        <div class="nav-item wf-item" onclick="UI.switchView('issuance', this)"><i class="fas fa-user-plus"></i> Starters (Issue)</div>
        <div class="nav-item wf-item" onclick="UI.switchView('movement', this)"><i class="fas fa-exchange-alt"></i> Movers (Transfer)</div>
        <div class="nav-item wf-item" onclick="UI.switchView('retrieval', this)"><i class="fas fa-user-minus"></i> Leavers (Return)</div>

        <div style="height:20px"></div>
        <div class="nav-label">Data</div>
        <div class="nav-item" onclick="DataService.exportCSV()"><i class="fas fa-download"></i> Backup</div>
        <div class="nav-item" onclick="document.getElementById('restore-input').click()"><i class="fas fa-upload"></i> Restore</div>
        <input type="file" id="restore-input" style="display:none" accept=".json" onchange="DataService.restoreData && DataService.restoreData(event)">

      </div>

      <div class="sidebar-footer">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div style="display:flex;align-items:center;gap:8px;color:#888">
            <i class="fas fa-moon"></i> <span style="font-size:13px">Dark Mode</span>
          </div>
          <label style="display:flex;align-items:center;gap:8px">
            <input type="checkbox" id="themeToggle" onchange="UI.toggleTheme()" />
          </label>
        </div>
        <div style="margin-top:12px">
          <div class="nav-item logout-btn" onclick="App.logout()"><i class="fas fa-sign-out-alt"></i> Sign Out</div>
        </div>
      </div>
    </div>

    <div class="main">
      <div class="header">
        <div style="display:flex;align-items:center;gap:16px">
          <div class="mobile-toggle" onclick="UI.toggleSidebar()"><i class="fas fa-bars" style="font-size:18px"></i></div>
          <div>
            <h2 id="pageTitle" style="margin:0">Dashboard</h2>
            <span id="currentDate" style="color:var(--text-light);font-size:13px">Loading...</span>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:14px">
          <div style="text-align:right">
            <div id="user-name-display" style="font-weight:800">Admin</div>
            <div id="user-role-display" style="font-size:12px;color:var(--text-light)">Manager</div>
          </div>
          <div id="user-avatar-display" style="width:44px;height:44px;background:var(--primary-black);border-radius:50%;display:flex;align-items:center;justify-content:center;border:3px solid var(--primary-yellow);color:var(--primary-yellow);font-weight:bold">AU</div>
        </div>
      </div>

      <div class="content-area">
        <div id="view-dashboard" class="view-section active-view">
          <div class="stats-row">
            <div class="card stat-card yellow"><h4 style="font-size:12px;color:var(--text-light);margin-bottom:5px">Actions Required</h4><div class="value">3</div></div>
            <div class="card stat-card red"><h4 style="font-size:12px;color:var(--text-light);margin-bottom:5px">Overdue</h4><div class="value">1</div></div>
            <div class="card stat-card"><h4 style="font-size:12px;color:var(--text-light);margin-bottom:5px">Total Assets</h4><div id="stat-total" class="value">0</div></div>
            <div class="card stat-card green"><h4 style="font-size:12px;color:var(--text-light);margin-bottom:5px">In Stock</h4><div id="stat-stock" class="value">0</div></div>
          </div>

          <div style="display:grid;grid-template-columns:2fr 1fr;gap:20px">
            <div class="card">
              <div class="tbl-header">
                <h3 style="margin:0">Recent Activity</h3>
                <span class="live-badge">LIVE</span>
              </div>
              <table id="activityTable" style="width:100%;margin-top:12px">
                <thead>
                  <tr><th>Ref</th><th>User</th><th>Type</th><th>Date</th><th>Status</th></tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <div class="card">
              <h3 style="margin-top:0">Asset Distribution</h3>
              <div style="height:220px"><canvas id="assetChart"></canvas></div>
            </div>
          </div>
        </div>

        <div id="view-inventory" class="view-section">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap">
            <div style="flex:1;position:relative;min-width:200px">
              <i class="fas fa-search" style="position:absolute;left:12px;top:12px;color:#999"></i>
              <input id="inv-search" onkeyup="UI.debouncedSearch()" class="form-control" style="padding-left:36px" placeholder="Search assets, users, models...">
            </div>

            <select id="inv-filter" class="form-control" onchange="UI.resetPagination()" style="width:auto">
              <option>All</option><option>Available</option><option>Assigned</option><option>Damaged</option><option>Maintenance</option>
            </select>

            <div style="display:flex;gap:8px">
              <button class="btn btn-secondary" onclick="DataService.triggerImport()" title="Import from CSV"><i class="fas fa-file-upload"></i> Import</button>
              <input type="file" id="import-csv" accept=".csv" style="display:none" onchange="DataService.handleImport(event)">
              
              <button class="btn btn-secondary" onclick="window.print()"><i class="fas fa-print"></i> Print</button>
              <button class="btn btn-secondary" onclick="DataService.exportCSV()"><i class="fas fa-file-download"></i> Export</button>
              <button class="btn btn-primary" id="btn-add-new" onclick="UI.openModal('add')"><i class="fas fa-plus"></i> Add Asset</button>
            </div>
          </div>

          <div class="card" style="overflow-x:auto">
            <table id="inventoryTable">
              <thead><tr><th onclick="UI.sortData('tag')">Asset Tag <i class="fas fa-sort"></i></th><th onclick="UI.sortData('type')">Type <i class="fas fa-sort"></i></th><th onclick="UI.sortData('model')">Model <i class="fas fa-sort"></i></th><th onclick="UI.sortData('user')">User <i class="fas fa-sort"></i></th><th onclick="UI.sortData('status')">Status <i class="fas fa-sort"></i></th><th>Action</th></tr></thead>
              <tbody id="inv-body"></tbody>
            </table>

            <div style="display:flex;align-items:center;justify-content:space-between;margin-top:12px">
              <div id="pg-info" style="font-size:13px;color:var(--text-light)">Loading...</div>
              <div style="display:flex;gap:8px">
                <button id="pg-prev" class="btn btn-secondary" onclick="UI.changePage(-1)">Prev</button>
                <button id="pg-next" class="btn btn-secondary" onclick="UI.changePage(1)">Next</button>
              </div>
            </div>
          </div>
        </div>

        <div id="view-history" class="view-section">
           <div class="card">
               <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
                   <h3 style="margin:0">System Audit Log</h3>
                   <button class="btn btn-secondary" onclick="window.print()">Print Log</button>
               </div>
               <div style="overflow:auto;max-height:calc(100vh - 180px)">
                   <table id="fullHistoryTable">
                       <thead style="position:sticky;top:0;background:var(--surface)">
                           <tr><th>Reference</th><th>Action Type</th><th>Performed By</th><th>Details</th><th>Date & Time</th></tr>
                       </thead>
                       <tbody id="history-body"></tbody>
                   </table>
               </div>
           </div>
        </div>

        <div id="view-issuance" class="view-section">
          <div class="card wf-card" id="issuance-card" style="max-width:600px;margin:0 auto">
            <div style="text-align:center;margin-bottom:12px;border-bottom:1px solid var(--border);padding-bottom:12px"><h3 style="margin:0">Asset Issuance</h3><p style="color:var(--text-light);margin:6px 0 0">Assign a device to a new starter</p></div>
            <div style="display:flex;gap:12px;justify-content:center;margin-bottom:18px">
              <div class="step active" id="i-step-1">1</div>
              <div class="step" id="i-step-2">2</div>
              <div class="step" id="i-step-3">3</div>
            </div>

            <div id="form-step-1">
              <div class="form-group"><label class="form-label">Full Name</label><input id="iss-name" class="form-control" oninput="Workflow.autoFillEmail()"></div>
              <div class="form-group"><label class="form-label">Email</label><input id="iss-email" class="form-control"></div>
              <div style="text-align:right"><button class="btn btn-primary" onclick="Workflow.nextStep(2)">Next</button></div>
            </div>

            <div id="form-step-2" style="display:none">
              <div class="form-group">
                  <label class="form-label">Asset Tag</label>
                  <div style="display:flex;gap:10px">
                    <input id="iss-tag" class="form-control" placeholder="Scan Barcode" onblur="Workflow.lookupAsset('iss')" onkeypress="if(event.key==='Enter') Workflow.lookupAsset('iss')">
                    <button class="btn btn-secondary" onclick="Workflow.lookupAsset('iss')"><i class="fas fa-search"></i></button>
                  </div>
              </div>
              
              <div id="iss-asset-display" style="display:none" class="asset-details-box">
                  <div class="asset-row"><span class="asset-label">Tag</span><span class="asset-val" id="iss-lbl-tag"></span></div>
                  <div class="asset-row"><span class="asset-label">Type</span><span class="asset-val" id="iss-lbl-type"></span></div>
                  <div class="asset-row"><span class="asset-label">Model</span><span class="asset-val" id="iss-lbl-model"></span></div>
                  <div class="asset-row"><span class="asset-label">Status</span><span class="asset-val" id="iss-lbl-status"></span></div>
              </div>

              <div style="text-align:right;margin-top:20px">
                  <button class="btn btn-ghost" onclick="Workflow.prevStep(1)">Back</button> 
                  <button class="btn btn-primary" onclick="Workflow.validateAndNext()">Next</button>
              </div>
            </div>

            <div id="form-step-3" style="display:none">
              <p style="color:var(--text-light);font-size:14px;font-style:italic;margin-bottom:12px">I acknowledge receipt of the asset listed above (Tag: <span id="summary-tag" style="font-weight:bold"></span>) and agree to the Acceptable Use Policy.</p>
              <div class="form-group"><label class="form-label">Initials</label><input id="iss-initials" maxlength="4" class="form-control" style="width:120px"></div>

              <div class="signature-wrapper" style="height:160px;margin-bottom:12px;position:relative">
                <div style="position:absolute;right:8px;top:8px;z-index:5;display:flex;gap:6px">
                  <label class="btn" style="background:#eee;padding:6px 8px;border-radius:6px;cursor:pointer"><i class="fas fa-upload"></i>
                    <input id="sig-upload" type="file" accept="image/*" style="display:none" onchange="Workflow.handleSigUpload(event)">
                  </label>
                  <button class="btn" onclick="Workflow.clearSig()" style="background:#ffeaea;color:var(--danger)">Clear</button>
                </div>
                <canvas id="sig-canvas" style="width:100%;height:100%;display:block;background:#fff;touch-action:none"></canvas>
              </div>

              <div style="text-align:right"><button class="btn btn-ghost" onclick="Workflow.prevStep(2)">Back</button> <button class="btn btn-primary" onclick="Workflow.completeIssuance(event)">Sign & Complete</button></div>
            </div>
          </div>
        </div>

        <div id="view-movement" class="view-section">
            <div class="card wf-card" style="max-width:600px;margin:0 auto">
                <div style="text-align:center;margin-bottom:20px;border-bottom:1px solid var(--border);padding-bottom:12px">
                    <h3 style="margin:0">Transfer Asset (Movers)</h3>
                    <p style="color:var(--text-light);margin:6px 0 0">Re-assign an asset to a new owner</p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Asset Tag to Transfer</label>
                    <div style="display:flex;gap:10px">
                        <input id="mov-tag" class="form-control" placeholder="Scan Tag" onblur="Workflow.lookupAsset('mov')">
                        <button class="btn btn-secondary" onclick="Workflow.lookupAsset('mov')"><i class="fas fa-search"></i></button>
                    </div>
                </div>

                <div id="mov-asset-display" style="display:none" class="asset-details-box">
                    <div class="asset-row"><span class="asset-label">Current Owner</span><span class="asset-val" id="mov-lbl-user"></span></div>
                    <div class="asset-row"><span class="asset-label">Model</span><span class="asset-val" id="mov-lbl-model"></span></div>
                    <div class="asset-row"><span class="asset-label">Current Status</span><span class="asset-val" id="mov-lbl-status"></span></div>
                </div>

                <div id="mov-new-details" style="display:none;margin-top:20px;padding-top:20px;border-top:1px solid var(--border)">
                    <div class="form-group">
                        <label class="form-label">New Owner Name</label>
                        <input id="mov-new-user" class="form-control" placeholder="e.g. Jane Smith">
                    </div>
                    <button class="btn btn-primary" style="width:100%" onclick="Workflow.processTransfer()">Confirm Transfer</button>
                </div>
            </div>
        </div>

        <div id="view-retrieval" class="view-section">
             <div class="card wf-card" id="return-card" style="max-width:600px;margin:0 auto">
                <div style="text-align:center;margin-bottom:20px;border-bottom:1px solid var(--border);padding-bottom:12px">
                    <h3 style="margin:0">Asset Return (Leavers)</h3>
                    <p style="color:var(--text-light);margin:6px 0 0">Check an asset back into stock</p>
                </div>

                <div class="form-group">
                    <label class="form-label">Asset Tag to Return</label>
                    <div style="display:flex;gap:10px">
                        <input id="ret-tag" class="form-control" placeholder="Scan Tag" onblur="Workflow.lookupAsset('ret')">
                        <button class="btn btn-secondary" onclick="Workflow.lookupAsset('ret')"><i class="fas fa-search"></i></button>
                    </div>
                </div>

                <div id="ret-asset-display" style="display:none" class="asset-details-box">
                    <div class="asset-row"><span class="asset-label">Returning User</span><span class="asset-val" id="ret-lbl-user"></span></div>
                    <div class="asset-row"><span class="asset-label">Model</span><span class="asset-val" id="ret-lbl-model"></span></div>
                </div>

                <div id="ret-details" style="display:none;margin-top:20px">
                    <div class="form-group">
                        <label class="form-label">Condition Assessment</label>
                        <select id="ret-condition" class="form-control">
                            <option value="Available">Good / Working Order</option>
                            <option value="Damaged">Damaged / Needs Repair</option>
                            <option value="Maintenance">Needs Maintenance/Wiping</option>
                        </select>
                    </div>
                    <div class="form-group">
                         <label class="form-label"><input type="checkbox" id="ret-receipt-check" checked> Generate Return Receipt (PDF)</label>
                    </div>
                    <button class="btn btn-danger" style="width:100%;background:var(--danger);color:#fff" onclick="Workflow.processReturn(event)">Process Return</button>
                </div>
            </div>
        </div>

      </div>
    </div>
  </div>

  <div class="modal-overlay" id="assetModal">
    <div class="modal" id="assetModalBox">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <h3 style="margin:0">Asset Details</h3>
        <i class="fas fa-times" style="cursor:pointer" onclick="UI.closeModal('assetModal')"></i>
      </div>

      <form onsubmit="UI.saveAsset(event)">
        <input type="hidden" id="mod-mode">
        <div class="form-group"><label class="form-label">Tag ID</label><input id="mod-tag" required class="form-control"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div class="form-group"><label class="form-label">Type</label><select id="mod-type" class="form-control"><option>Laptop</option><option>Mobile</option><option>Monitor</option><option>Accessory</option></select></div>
          <div class="form-group"><label class="form-label">Status</label><select id="mod-status" class="form-control"><option>Available</option><option>Assigned</option><option>Damaged</option><option>Maintenance</option></select></div>
        </div>
        <div class="form-group"><label class="form-label">Model</label><input id="mod-model" class="form-control" required></div>
        <div class="form-group"><label class="form-label">User</label><input id="mod-user" class="form-control"></div>

        <div style="display:flex;justify-content:space-between;margin-top:20px">
          <button type="button" class="btn" id="btn-delete-asset" style="background:#ffeaea;color:var(--danger);display:none" onclick="UI.deleteAsset()">Delete</button>
          <div style="display:flex;gap:8px;margin-left:auto">
            <button type="button" class="btn btn-secondary" onclick="UI.closeModal('assetModal')">Cancel</button>
            <button type="submit" class="btn btn-primary">Save</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="modal-overlay" id="qrModal">
    <div class="modal" style="text-align:center;width:300px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <h3 style="margin:0">Asset QR</h3>
        <i class="fas fa-times" style="cursor:pointer" onclick="UI.closeModal('qrModal')"></i>
      </div>
      <div id="qr-display" style="margin:20px auto;display:flex;justify-content:center"></div>
      <h4 id="qr-tag-label" style="margin-top:10px;font-family:monospace;font-size:16px"></h4>
    </div>
  </div>

  <div id="toastContainer" style="position:fixed;right:20px;bottom:20px;z-index:1200;display:flex;flex-direction:column;align-items:flex-end"></div>

  <script>
  /* ---------- UTILS ---------- */
  const Utils = {
    escape: (str) => str ? String(str).replace(/[&<>"']/g, m => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' })[m]) : '',
    debounce: (func, wait=300) => {
      let timeout = null;
      return function(...args){
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    },
    formatDate: (iso) => {
      try {
        const d = new Date(iso);
        if(isNaN(d)) return iso;
        return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
      } catch(e){ return iso; }
    }
  };

  /* ---------- APP ---------- */
  const App = {
    isSignup:false,
    init: () => {
      if(localStorage.getItem('ensTheme') === 'dark') document.body.classList.add('dark-mode');
      document.getElementById('themeToggle').checked = document.body.classList.contains('dark-mode');
      DataService.init();
      const user = JSON.parse(localStorage.getItem('ensCurrentUser') || 'null');
      user ? App.showDashboard(user) : App.showLogin();
      
      const logoImg = document.getElementById('login-logo');
      logoImg.onerror = () => { logoImg.style.display='none'; };
    },

    toggleAuthMode: () => {
      App.isSignup = !App.isSignup;
      document.querySelectorAll('.signup-field').forEach(f => f.style.display = App.isSignup ? 'block':'none');
      document.getElementById('auth-subtitle').innerText = App.isSignup ? 'Create a new account' : 'Enterprise Asset Management';
      document.getElementById('auth-btn-label').innerText = App.isSignup ? 'Create Account' : 'Sign In';
      document.getElementById('auth-switch-text').innerText = App.isSignup ? 'Have an account?':'Don\'t have an account?';
      document.getElementById('auth-switch-link').innerText = App.isSignup ? 'Sign In' : 'Sign Up';
    },

    handleAuth: (e) => {
      e.preventDefault();
      const email = (document.getElementById('login-email').value || '').trim();
      const pass = (document.getElementById('login-password').value || '').trim();
      const err = document.getElementById('login-error');
      const btn = document.getElementById('btn-login');

      err.style.display='none';
      if(!email || !pass){ err.innerText='All fields required'; err.style.display='block'; return; }

      btn.disabled = true;
      btn.style.opacity = '0.7';
      
      setTimeout(() => {
        let users = DataService.get('ensUsers');
        if(App.isSignup){
          const name = (document.getElementById('signup-name').value||'').trim();
          const role = document.getElementById('signup-role').value;
          if(!name){ err.innerText='Name required'; err.style.display='block'; btn.disabled=false; btn.style.opacity='1'; return; }
          if(users.find(u=>u.username===email)){ err.innerText='User already exists'; err.style.display='block'; btn.disabled=false; btn.style.opacity='1'; return; }
          const newUser = { id: Date.now(), username: email, password: pass, name, role, office:'HQ' };
          users.push(newUser);
          DataService.set('ensUsers', users);
          localStorage.setItem('ensCurrentUser', JSON.stringify(newUser));
          App.showDashboard(newUser);
        } else {
          const user = users.find(u=>u.username===email && u.password===pass);
          if(user){ localStorage.setItem('ensCurrentUser', JSON.stringify(user)); App.showDashboard(user); }
          else { err.innerText='Invalid credentials'; err.style.display='block'; }
        }
        btn.disabled=false;
        btn.style.opacity = '1';
      }, 450);
    },

    logout: () => {
      if(confirm('Sign out?')){ localStorage.removeItem('ensCurrentUser'); location.reload(); }
    },

    showLogin: () => {
      document.getElementById('view-login').style.display='block';
      document.body.classList.add('login-mode');
      document.getElementById('view-app').style.display='none';
    },

    showDashboard: (user) => {
      UI.updateProfile(user);
      UI.applyPermissions(user);
      document.getElementById('currentDate').innerText = new Date().toLocaleDateString('en-GB', { weekday:'long', day:'numeric', month:'long' });
      document.getElementById('view-login').style.display='none';
      document.body.classList.remove('login-mode');
      document.getElementById('view-app').style.display='flex';
      UI.renderDashboard();
    }
  };

  /* ---------- DATA SERVICE ---------- */
  const DataService = {
    init: () => {
      if(!localStorage.getItem('ensUsers')){
        localStorage.setItem('ensUsers', JSON.stringify([{ id:1, username:'admin', password:'password', name:'Admin User', role:'IT Manager', office:'Sandton'}]));
      }
      if(!localStorage.getItem('ensInventory')){
        localStorage.setItem('ensInventory', JSON.stringify([
          { tag:'ENS-L-001', type:'Laptop', model:'Dell Latitude 7420', user:'System', status:'Available' },
          { tag:'ENS-M-102', type:'Mobile', model:'iPhone 13', user:'Sarah Connor', status:'Assigned' }
        ]));
      }
      if(!localStorage.getItem('ensActivity')) localStorage.setItem('ensActivity', JSON.stringify([]));
    },

    get: (k) => {
      try { return JSON.parse(localStorage.getItem(k) || '[]'); } catch(e){ return []; }
    },

    set: (k, v) => { localStorage.setItem(k, JSON.stringify(v)); },

    updateInv: (tag, data) => {
      let inv = DataService.get('ensInventory');
      const idx = inv.findIndex(i => i.tag === tag);
      if(idx > -1) inv[idx] = { ...inv[idx], ...data };
      else inv.push({ tag, ...data });
      DataService.set('ensInventory', inv);
    },

    log: (type, details, user) => {
      let log = DataService.get('ensActivity') || [];
      log.unshift({ ref: `LOG-${Date.now().toString().slice(-5)}`, type, user, date: new Date().toISOString(), details });
      // Keep last 2000 records
      if(log.length > 2000) log.length = 2000;
      DataService.set('ensActivity', log);
    },

    exportCSV: () => {
      const data = DataService.get('ensInventory');
      const csv = Papa.unparse(data);
      const link = document.createElement('a');
      link.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
      link.download = `ENS_Inventory_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(link);
      link.click();
      link.remove();
    },

    triggerImport: () => { document.getElementById('import-csv').click(); },

    handleImport: (ev) => {
        const file = ev.target.files[0];
        if(!file) return;
        Papa.parse(file, {
            header: true, skipEmptyLines: true,
            complete: function(results) {
                if(results.data && results.data.length > 0) {
                    let count = 0;
                    results.data.forEach(row => {
                        const tag = row.Tag || row.tag;
                        if(tag) {
                            const update = {
                                type: row.Type || row.type || 'Unknown',
                                model: row.Model || row.model || 'Unknown',
                                user: row.User || row.user || '',
                                status: row.Status || row.status || 'Available'
                            };
                            DataService.updateInv(tag, update);
                            count++;
                        }
                    });
                    UI.toast(`Imported ${count} assets`, 'success');
                    UI.renderInventory(); UI.renderDashboard();
                    DataService.log('System', `Imported ${count} assets from CSV`, 'Admin');
                } else { UI.toast('No valid data found', 'error'); }
            }
        });
        ev.target.value = '';
    },

    restoreData: (ev) => {
      const file = ev.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const json = JSON.parse(e.target.result);
          if(json.ensInventory) localStorage.setItem('ensInventory', JSON.stringify(json.ensInventory));
          if(json.ensUsers) localStorage.setItem('ensUsers', JSON.stringify(json.ensUsers));
          if(json.ensActivity) localStorage.setItem('ensActivity', JSON.stringify(json.ensActivity));
          location.reload();
        } catch(err){ alert('Invalid backup file'); }
      };
      reader.readAsText(file);
    }
  };


  /* ---------- UI ---------- */
  const UI = {
    pg:1, limit:10, sort:{col:null,asc:true},

    toggleTheme: () => {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('ensTheme', document.body.classList.contains('dark-mode') ? 'dark':'light');
    },

    applyPermissions: (user) => {
      const readOnly = ['Auditor','Viewer'].includes(user.role);
      const btn = document.getElementById('btn-add-new');
      if(btn) btn.style.display = readOnly ? 'none' : 'inline-flex';
    },

    updateProfile: (u) => {
      document.getElementById('user-name-display').innerText = u.name || 'User';
      document.getElementById('user-role-display').innerText = u.role || '';
      document.getElementById('user-avatar-display').innerText = (u.name||'').substring(0,2).toUpperCase();
    },

    toast: (msg, type='info') => {
        const c = document.getElementById('toastContainer');
        const t = document.createElement('div');
        t.className = 'toast';
        t.style.borderLeft = `4px solid ${type==='error'?'#e74c3c':type==='success'?'#27ae60':'#FFD200'}`;
        t.innerText = msg;
        c.appendChild(t);
        setTimeout(()=>t.remove(), 3000);
    },

    switchView: (view, btn) => {
      document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
      if(btn) btn.classList.add('active');
      document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active-view'));
      const el = document.getElementById('view-'+view);
      if(el) el.classList.add('active-view');
      // Automatically close sidebar when a view is clicked
      document.getElementById('sidebar').classList.remove('active');
      
      if(view==='dashboard') UI.renderDashboard();
      if(view==='inventory') UI.renderInventory();
      if(view==='history') UI.renderHistory();
    },

    toggleSidebar: () => document.getElementById('sidebar').classList.toggle('active'),

    renderDashboard: () => {
      const inv = DataService.get('ensInventory');
      const logs = DataService.get('ensActivity');

      document.getElementById('stat-total').innerText = (inv||[]).length;
      document.getElementById('stat-stock').innerText = (inv||[]).filter(i=>i.status==='Available').length;

      const tbody = document.querySelector('#activityTable tbody');
      tbody.innerHTML = (logs||[]).slice(0,5).map(l => `
        <tr>
          <td><span style="font-family:monospace">${Utils.escape(l.ref)}</span></td>
          <td>${Utils.escape(l.user)}</td>
          <td>${Utils.escape(l.type)}</td>
          <td>${Utils.formatDate(l.date)}</td>
          <td><span class="status-badge st-good">DONE</span></td>
        </tr>
      `).join('');

      // Chart
      const counts = {};
      (inv||[]).forEach(i => counts[i.type] = (counts[i.type]||0) + 1);

      const ctx = document.getElementById('assetChart');
      if(ctx && ctx.offsetParent !== null) {
          if(window.myChart) window.myChart.destroy();
          window.myChart = new Chart(ctx.getContext('2d'), {
            type: 'doughnut',
            data: {
              labels: Object.keys(counts),
              datasets: [{ data: Object.values(counts), backgroundColor: ['#FFD200','#111','#3498db','#e74c3c'], borderWidth:0 }]
            },
            options:{responsive:true,maintainAspectRatio:false,cutout:'65%',plugins:{legend:{position:'right'}}}
          });
      }
    },
    
    renderHistory: () => {
        const logs = DataService.get('ensActivity');
        const tbody = document.getElementById('history-body');
        tbody.innerHTML = logs.map(l => `
            <tr>
              <td style="font-family:monospace;font-weight:bold">${Utils.escape(l.ref)}</td>
              <td>${Utils.escape(l.type)}</td>
              <td>${Utils.escape(l.user)}</td>
              <td>${Utils.escape(l.details)}</td>
              <td>${Utils.formatDate(l.date)}</td>
            </tr>
        `).join('');
    },

    debouncedSearch: Utils.debounce(()=>UI.renderInventory(), 300),

    sortData: (col) => {
      if(UI.sort.col === col) UI.sort.asc = !UI.sort.asc;
      else { UI.sort.col = col; UI.sort.asc = true; }
      UI.renderInventory();
    },

    renderInventory: () => {
      const search = (document.getElementById('inv-search').value || '').toLowerCase();
      const filter = (document.getElementById('inv-filter').value || 'All');
      let data = DataService.get('ensInventory') || [];

      data = data.filter(i => {
        const matchSearch = Object.values(i).some(val => String(val||'').toLowerCase().includes(search));
        const matchFilter = filter==='All' || i.status === filter;
        return matchSearch && matchFilter;
      });

      // sorting
      if(UI.sort.col){
        data.sort((a,b)=>{
          let va = a[UI.sort.col] || '';
          let vb = b[UI.sort.col] || '';
          const numA = parseFloat(va), numB = parseFloat(vb);
          if(!isNaN(numA) && !isNaN(numB)) return UI.sort.asc ? numA - numB : numB - numA;
          va = String(va).toLowerCase(); vb = String(vb).toLowerCase();
          if(va < vb) return UI.sort.asc ? -1 : 1;
          if(va > vb) return UI.sort.asc ? 1 : -1;
          return 0;
        });
      }

      const total = data.length;
      const start = (UI.pg - 1) * UI.limit;
      const pageData = data.slice(start, start + UI.limit);

      const startText = total === 0 ? 0 : Math.min(start + 1, total);
      const endText = total === 0 ? 0 : Math.min(start + UI.limit, total);

      document.getElementById('pg-info').innerText = `Showing ${startText} - ${endText} of ${total}`;
      document.getElementById('pg-prev').disabled = UI.pg === 1;
      document.getElementById('pg-next').disabled = start + UI.limit >= total;

      const tbody = document.getElementById('inv-body');
      tbody.innerHTML = '';
      const frag = document.createDocumentFragment();

      pageData.forEach(row=>{
        const tr = document.createElement('tr');
        let badgeClass = row.status === 'Available' ? 'st-good' : row.status === 'Assigned' ? 'st-assigned' : row.status === 'Maintenance' ? 'st-maint' : 'st-damaged';
        tr.innerHTML = `
          <td style="font-weight:bold">${Utils.escape(row.tag)}</td>
          <td>${Utils.escape(row.type)}</td>
          <td>${Utils.escape(row.model)}</td>
          <td>${Utils.escape(row.user)}</td>
          <td><span class="status-badge ${badgeClass}">${Utils.escape(row.status)}</span></td>
          <td>
            <button class="btn btn-secondary" onclick="UI.showQR('${row.tag}')" title="QR Code"><i class="fas fa-qrcode"></i></button>
            <button class="btn btn-secondary" onclick="UI.openModal('edit','${row.tag}')" title="Edit"><i class="fas fa-edit"></i></button>
          </td>
        `;
        frag.appendChild(tr);
      });

      if(pageData.length === 0) tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:#999">No assets found</td></tr>';
      else tbody.appendChild(frag);
    },

    changePage: (dir) => { UI.pg = Math.max(1, UI.pg + dir); UI.renderInventory(); },
    resetPagination: () => { UI.pg = 1; UI.renderInventory(); },

    openModal: (mode, tag) => {
      const modal = document.getElementById('assetModal');
      document.getElementById('mod-mode').value = mode;
      const form = modal.querySelector('form');
      form.reset();
      if(mode === 'edit'){
        const item = DataService.get('ensInventory').find(i => i.tag === tag) || {};
        document.getElementById('mod-tag').value = item.tag || '';
        document.getElementById('mod-tag').disabled = true;
        document.getElementById('mod-type').value = item.type || 'Laptop';
        document.getElementById('mod-model').value = item.model || '';
        document.getElementById('mod-status').value = item.status || 'Available';
        document.getElementById('mod-user').value = item.user || '';
        document.getElementById('btn-delete-asset').style.display = 'inline-block';
      } else {
        document.getElementById('mod-tag').disabled = false;
        document.getElementById('btn-delete-asset').style.display = 'none';
      }
      modal.style.display = 'flex';
      setTimeout(()=>modal.classList.add('open'),10);
    },

    closeModal: (id) => {
      const modal = document.getElementById(id);
      if(!modal) return;
      modal.classList.remove('open');
      setTimeout(()=>modal.style.display='none',220);
    },

    saveAsset: (e) => {
      e.preventDefault();
      const mode = document.getElementById('mod-mode').value;
      const tag = (document.getElementById('mod-tag').value || '').trim();
      if(!tag){ alert('Tag required'); return; }
      
      if(mode !== 'edit') {
          const existing = DataService.get('ensInventory').find(i => i.tag === tag);
          if(existing) { alert('Asset Tag already exists!'); return; }
      }

      const data = {
        type: document.getElementById('mod-type').value,
        model: document.getElementById('mod-model').value,
        status: document.getElementById('mod-status').value,
        user: document.getElementById('mod-user').value
      };
      
      DataService.updateInv(tag, data);
      DataService.log(mode==='edit'?'Asset Update':'Asset Create', `Saved ${tag}`, JSON.parse(localStorage.getItem('ensCurrentUser')||'{}').name || 'System');
      UI.closeModal('assetModal');
      UI.renderInventory(); UI.renderDashboard();
      UI.toast('Asset saved successfully', 'success');
    },

    deleteAsset: () => {
      const tag = document.getElementById('mod-tag').value;
      if(!confirm(`Delete ${tag}?`)) return;
      let inv = DataService.get('ensInventory');
      inv = inv.filter(i=>i.tag !== tag);
      DataService.set('ensInventory', inv);
      UI.closeModal('assetModal');
      UI.renderInventory(); UI.renderDashboard();
      UI.toast('Asset deleted', 'info');
    },

    showQR: (tag) => {
      const box = document.getElementById('qr-display');
      box.innerHTML = '';
      document.getElementById('qr-tag-label').innerText = tag;
      
      const modal = document.getElementById('qrModal');
      modal.style.display = 'flex';
      setTimeout(()=> {
          modal.classList.add('open');
          new QRCode(box, { text: tag, width: 128, height: 128 });
      },10);
    }
  };


/* ---------- WORKFLOW (UPDATED WITH SAFETY LOGIC) ---------- */
  const Workflow = {
    currentStep: 1,
    ctx: null,
    sigInitialized: false,
    activeAsset: null,

    nextStep: (n) => {
      if(n === 2 && !document.getElementById('iss-name').value) return alert('Name required');
      
      document.querySelectorAll('[id^="form-step-"]').forEach(el=>el.style.display='none');
      const el = document.getElementById(`form-step-${n}`);
      if(el) el.style.display='block';

      document.querySelectorAll('.step').forEach(s=>s.classList.remove('active'));
      const stepEl = document.getElementById(`i-step-${n}`);
      if(stepEl) stepEl.classList.add('active');

      if(n===3) {
          setTimeout(Workflow.initSig, 50); 
          document.getElementById('summary-tag').innerText = document.getElementById('iss-tag').value;
      }
      Workflow.currentStep = n;
    },
    
    // LOGIC FIX: Added stricter status checks during lookup
    lookupAsset: (mode) => {
        const tagField = document.getElementById(mode + '-tag');
        const tag = (tagField.value || '').trim();
        if(!tag) return;
        
        const assets = DataService.get('ensInventory');
        const found = assets.find(a => a.tag.toLowerCase() === tag.toLowerCase());
        Workflow.activeAsset = found;
        
        const display = document.getElementById(mode + '-asset-display');
        const displayNew = document.getElementById(mode + '-new-details') || document.getElementById(mode + '-details');
        
        // Reset displays
        if(displayNew) displayNew.style.display = 'none';

        if(found) {
            display.style.display = 'block';
            
            // --- LOGIC GUARDS ---
            // 1. Issuance: Warn if already assigned
            if(mode === 'iss' && found.status === 'Assigned') {
                display.style.borderColor = 'var(--danger)';
                alert(`WARNING: Asset ${tag} is currently assigned to ${found.user}. You should Return it before re-issuing.`);
            } 
            // 2. Transfer: Block if not assigned
            else if (mode === 'mov' && found.status !== 'Assigned') {
                display.style.borderColor = 'var(--danger)';
                alert(`ERROR: Asset ${tag} is ${found.status}. You cannot transfer an unassigned asset.`);
                Workflow.activeAsset = null; // Prevent proceeding
                return; 
            }
            // 3. Return: Block if already available
            else if (mode === 'ret' && found.status === 'Available') {
                display.style.borderColor = 'var(--danger)';
                alert(`Note: Asset ${tag} is already in stock.`);
            }
            else {
                display.style.borderColor = 'var(--success)';
            }

            // Render Labels
            if(mode === 'iss'){
                document.getElementById('iss-lbl-tag').innerText = found.tag;
                document.getElementById('iss-lbl-type').innerText = found.type;
                document.getElementById('iss-lbl-model').innerText = found.model;
                document.getElementById('iss-lbl-status').innerText = found.status;
            } else if(mode === 'mov'){
                document.getElementById('mov-lbl-user').innerText = found.user || 'Unassigned';
                document.getElementById('mov-lbl-model').innerText = found.model;
                document.getElementById('mov-lbl-status').innerText = found.status;
                if(displayNew) displayNew.style.display = 'block';
            } else if(mode === 'ret'){
                document.getElementById('ret-lbl-user').innerText = found.user || 'Unassigned';
                document.getElementById('ret-lbl-model').innerText = found.model;
                if(displayNew) displayNew.style.display = 'block';
            }
        } else {
            display.style.display = 'block';
            display.style.borderColor = 'var(--danger)';
            display.innerHTML = `<div style="color:var(--danger);font-weight:bold;text-align:center">Asset Tag Not Found</div>`;
            setTimeout(() => { display.style.display = 'none'; display.innerHTML=''; }, 2000);
        }
    },
    
    validateAndNext: () => {
        const tag = document.getElementById('iss-tag').value;
        if(!tag) return alert('Please scan or enter an Asset Tag');
        
        // Ensure lookup happens
        if(!Workflow.activeAsset || Workflow.activeAsset.tag !== tag) {
             Workflow.lookupAsset('iss');
        }
        
        setTimeout(() => {
             if(!Workflow.activeAsset) return alert('Asset not found');
             // LOGIC FIX: Stop Issuance if asset is assigned
             if(Workflow.activeAsset.status === 'Assigned') {
                 if(!confirm(`Asset is currently assigned to ${Workflow.activeAsset.user}. Overwrite assignment?`)) return;
             }
             Workflow.nextStep(3);
        }, 250);
    },

    // UI FIX: Clear signature when going back
    prevStep: (n) => { 
        if(n === 2) Workflow.clearSig();
        Workflow.nextStep(n); 
    },

    autoFillEmail: () => {
      const name = (document.getElementById('iss-name').value || '').trim();
      const mail = document.getElementById('iss-email');
      if(name && mail && !mail.value) mail.value = name.toLowerCase().replace(/\s+/g, '.') + '@ensafrica.com';
    },

    handleSigUpload: (e) => {
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        const img = new Image();
        img.onload = () => {
          const c = document.getElementById('sig-canvas');
          const ctx = c.getContext('2d');
          ctx.clearRect(0,0,c.width,c.height);
          const scale = Math.min(c.width/img.width, c.height/img.height);
          const w = img.width * scale, h = img.height * scale;
          ctx.drawImage(img, (c.width-w)/2, (c.height-h)/2, w,h);
        };
        img.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    },

    initSig: () => {
      const canvas = document.getElementById('sig-canvas');
      if(!canvas) return;
      const ratio = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      if(rect.width === 0) return; 

      canvas.width = Math.floor(rect.width * ratio);
      canvas.height = Math.floor(rect.height * ratio);
      canvas.style.width = rect.width + 'px';
      canvas.style.height = rect.height + 'px';

      Workflow.ctx = canvas.getContext('2d');
      Workflow.ctx.scale(ratio, ratio);
      Workflow.ctx.strokeStyle = "#000";
      Workflow.ctx.lineWidth = 2;
      Workflow.ctx.lineCap = 'round';

      if(Workflow.sigInitialized) return; 

      let drawing = false;
      const getPos = (e) => {
        const r = canvas.getBoundingClientRect();
        if(e.touches && e.touches[0]) return { x: e.touches[0].clientX - r.left, y: e.touches[0].clientY - r.top };
        return { x: e.clientX - r.left, y: e.clientY - r.top };
      };
      const start = (e) => { if(e.target!==canvas)return; e.preventDefault(); drawing=true; Workflow.ctx.beginPath(); const p=getPos(e); Workflow.ctx.moveTo(p.x,p.y); };
      const move = (e) => { if(!drawing)return; e.preventDefault(); const p=getPos(e); Workflow.ctx.lineTo(p.x,p.y); Workflow.ctx.stroke(); };
      const end = (e) => { drawing = false; };

      canvas.onpointerdown = start; canvas.onpointermove = move; canvas.onpointerup = end; canvas.onpointercancel = end;
      canvas.ontouchstart = start; canvas.ontouchmove = move; canvas.ontouchend = end;
      Workflow.sigInitialized = true;
    },

    clearSig: () => {
      const c = document.getElementById('sig-canvas');
      if(!c) return;
      const ctx = c.getContext('2d');
      ctx.clearRect(0,0,c.width,c.height);
      const fu = document.getElementById('sig-upload'); if(fu) fu.value = '';
    },

    completeIssuance: (event) => {
      const tag = (document.getElementById('iss-tag').value || '').trim();
      const name = (document.getElementById('iss-name').value || '').trim();
      const init = (document.getElementById('iss-initials').value || '').trim();
      if(!init) return alert('Initials required');
      
      // Logic Check before finalizing
      if(Workflow.activeAsset && Workflow.activeAsset.status === 'Assigned') {
           // Double check in case they bypassed the previous alert
           if(!confirm(`FINAL WARNING: This asset is owned by ${Workflow.activeAsset.user}. Re-assign to ${name}?`)) return;
      }

      const btn = event.target;
      btn.disabled = true; btn.innerText = 'Processing...';

      const step1 = document.getElementById('form-step-1');
      const step2 = document.getElementById('form-step-2');
      
      const s1d = step1.style.display; const s2d = step2.style.display;
      step1.style.display = 'block'; step2.style.display = 'block';
      const btns = document.querySelectorAll('#issuance-card button');
      btns.forEach(b => b.style.display = 'none');
      document.querySelector('.signature-wrapper label').style.display='none';

      const node = document.getElementById('issuance-card');
      
      const opt = {
        margin:10, filename:`ENS_Issue_${tag}.pdf`,
        image:{ type:'jpeg', quality:0.98 },
        html2canvas:{ scale:2 },
        jsPDF:{ unit:'mm', format:'a4', orientation:'portrait' }
      };

      html2pdf().set(opt).from(node).save().then(()=>{
        if(tag){ 
            DataService.updateInv(tag, { user: name, status: 'Assigned' }); 
            DataService.log('Issuance', `Issued ${tag} to ${name}`, JSON.parse(localStorage.getItem('ensCurrentUser')||'{}').name || 'System'); 
        }
        UI.toast('Issuance recorded & PDF downloaded', 'success');
        
        step1.style.display = s1d; step2.style.display = s2d;
        btns.forEach(b => b.style.display = '');
        document.querySelector('.signature-wrapper label').style.display='';

        setTimeout(() => {
             UI.switchView('dashboard');
             btn.disabled=false; btn.innerText='Sign & Complete';
             document.getElementById('iss-name').value='';
             document.getElementById('iss-email').value='';
             document.getElementById('iss-tag').value='';
             document.getElementById('iss-initials').value='';
             document.getElementById('iss-asset-display').style.display='none';
             Workflow.clearSig(); Workflow.nextStep(1);
        }, 1500);
      });
    },

    processTransfer: () => {
        const tag = document.getElementById('mov-tag').value;
        const newUser = document.getElementById('mov-new-user').value;
        if(!tag || !newUser) return alert('Tag and New User required');
        
        if(!Workflow.activeAsset || Workflow.activeAsset.tag !== tag) return alert('Re-scan tag to confirm');
        
        // Logic Check
        if(Workflow.activeAsset.status !== 'Assigned') return alert('Cannot transfer: Asset is not currently assigned to anyone.');

        const oldUser = Workflow.activeAsset.user;
        DataService.updateInv(tag, { user: newUser, status: 'Assigned' });
        DataService.log('Transfer', `Transferred ${tag} from ${oldUser} to ${newUser}`, 'Admin');
        
        UI.toast('Asset Transferred Successfully', 'success');
        setTimeout(() => {
             UI.switchView('dashboard');
             document.getElementById('mov-tag').value='';
             document.getElementById('mov-new-user').value='';
             document.getElementById('mov-asset-display').style.display='none';
             document.getElementById('mov-new-details').style.display='none';
        }, 1000);
    },

    processReturn: (e) => {
        const tag = document.getElementById('ret-tag').value;
        const cond = document.getElementById('ret-condition').value;
        if(!tag) return alert('Tag required');
        if(!Workflow.activeAsset || Workflow.activeAsset.tag !== tag) return alert('Re-scan tag to confirm');
        
        // Logic Check
        if(Workflow.activeAsset.status === 'Available') return alert('Asset is already checked in/available.');

        const currentUser = Workflow.activeAsset.user;
        
        const btn = e.target;
        const doPdf = document.getElementById('ret-receipt-check').checked;

        if(doPdf) {
            btn.disabled=true; btn.innerText = 'Generating Receipt...';
            const element = document.getElementById('return-card');
            const btns = element.querySelectorAll('button, input[type=checkbox]');
            btns.forEach(b=>b.style.display='none');
            
            html2pdf().from(element).save(`ENS_Return_${tag}.pdf`).then(() => {
                Workflow._finalizeReturn(tag, cond, currentUser);
                btns.forEach(b=>b.style.display='');
                btn.disabled=false; btn.innerText='Process Return';
            });
        } else {
            Workflow._finalizeReturn(tag, cond, currentUser);
        }
    },
    
    _finalizeReturn: (tag, cond, oldUser) => {
        DataService.updateInv(tag, { user: '', status: cond });
        DataService.log('Return', `Returned ${tag} from ${oldUser} (Condition: ${cond})`, 'Admin');
        UI.toast('Asset Returned to Stock', 'success');
        setTimeout(() => {
             UI.switchView('dashboard');
             document.getElementById('ret-tag').value='';
             document.getElementById('ret-asset-display').style.display='none';
             document.getElementById('ret-details').style.display='none';
        }, 1000);
    }
  };
    
    _finalizeReturn: (tag, cond, oldUser) => {
        DataService.updateInv(tag, { user: '', status: cond });
        DataService.log('Return', `Returned ${tag} from ${oldUser} (Condition: ${cond})`, 'Admin');
        UI.toast('Asset Returned to Stock', 'success');
        setTimeout(() => {
             UI.switchView('dashboard');
             document.getElementById('ret-tag').value='';
             document.getElementById('ret-asset-display').style.display='none';
             document.getElementById('ret-details').style.display='none';
        }, 1000);
    }
  };

  /* ---------- START ---------- */
  document.addEventListener('DOMContentLoaded', App.init);
  </script>
</body>
</html>

